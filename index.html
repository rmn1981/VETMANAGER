<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>VetManager v19.0</title>
    <style>
        /* --- CORE CSS --- */
        :root { --primary: #27ae60; --dark: #2c3e50; --bg: #f8f9fa; --card: #ffffff; --border: #e9ecef; --text: #343a40; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); margin: 0; padding-bottom: 100px; color: var(--text); -webkit-font-smoothing: antialiased; }
        .container { max-width: 600px; margin: 0 auto; background: var(--card); min-height: 100vh; box-shadow: 0 0 30px rgba(0,0,0,0.03); }

        /* HEADER APP */
        .app-header { background: var(--dark); color: white; padding: 15px 20px; display: flex; justify-content: space-between; align-items: center; }
        .app-header h2 { margin: 0; font-size: 1.1rem; font-weight: 700; }
        .btn-reset { background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); color: white; font-size: 0.7rem; padding: 6px 12px; border-radius: 4px; cursor: pointer; }

        /* TABS */
        .nav-tabs { display: flex; background: #34495e; position: sticky; top: 0; z-index: 99; }
        .nav-item { flex: 1; padding: 15px; text-align: center; color: #aab0b6; cursor: pointer; border-bottom: 3px solid transparent; font-weight: 700; font-size: 0.85rem; text-transform: uppercase; transition: 0.3s; }
        .nav-item.active { color: white; border-bottom-color: var(--primary); background: #2b3b4b; }
        .tab-content { display: none; padding: 20px; animation: fadeIn 0.3s ease; }
        .tab-content.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        /* UI ELEMENTS */
        .section-label { color: #2980b9; font-size: 0.8rem; font-weight: 800; text-transform: uppercase; margin-top: 20px; margin-bottom: 8px; letter-spacing: 0.5px; }
        input, select, textarea { width: 100%; padding: 12px; border: 1px solid #ced4da; border-radius: 6px; font-size: 16px; box-sizing: border-box; background: #fff; font-family: inherit; }
        input:focus, select:focus { border-color: var(--primary); outline: none; }
        .row { display: flex; gap: 10px; margin-top: 10px; }
        .col { flex: 1; }

        /* LISTA CL√çNICA */
        .symptoms-list { height: 350px; overflow-y: auto; background: #fff; border: 1px solid var(--border); border-radius: 8px; margin-top: 5px; }
        .cat-header { background: #e9ecef; color: #6c757d; font-size: 0.7rem; font-weight: 700; text-transform: uppercase; padding: 8px 15px; position: sticky; top: 0; border-bottom: 1px solid var(--border); }
        .symptom-item { display: flex; align-items: flex-start; padding: 12px 15px; border-bottom: 1px solid #f1f3f5; cursor: pointer; }
        .symptom-item.selected { background-color: #e8f5e9; }
        .symptom-item input { width: 20px; height: 20px; margin: 2px 15px 0 0; accent-color: var(--primary); flex-shrink: 0; }
        .pat-info { display: flex; flex-direction: column; }
        .pat-name { font-size: 0.9rem; font-weight: 700; }
        .med-name { font-size: 0.8rem; color: var(--primary); font-weight: 700; }
        .med-detail { font-size: 0.75rem; color: #888; }

        /* ASSINATURA & CONFIG */
        .sig-status-box { padding: 15px; background: #d4edda; border: 1px solid #c3e6cb; color: #155724; border-radius: 8px; text-align: center; font-size: 0.9rem; margin-top: 10px; display: none; }
        .sig-status-box.missing { background: #f8d7da; border-color: #f5c6cb; color: #721c24; display: block; }
        
        .sig-manager { border: 2px dashed #ced4da; padding: 15px; border-radius: 8px; background: #fff; margin-top: 5px; }
        .canvas-wrapper { border: 1px solid #ccc; height: 150px; background: #fff; margin-top: 10px; touch-action: none; position: relative; }
        canvas { width: 100%; height: 100%; display: block; }
        
        /* BOTOES */
        .btn { width: 100%; padding: 15px; margin-top: 20px; border: none; border-radius: 8px; font-size: 1rem; font-weight: 700; cursor: pointer; display: flex; justify-content: center; gap: 8px; text-transform: uppercase; }
        .btn-calc { background: var(--primary); color: white; }
        .btn-print { background: #3498db; color: white; margin-top: 15px; }
        .btn-save { background: var(--dark); color: white; margin-top: 10px; }
        .btn-mini { padding: 5px 10px; font-size: 0.75rem; border-radius: 4px; border: none; cursor: pointer; background: #e74c3c; color: white; }
        .btn-tab-sig { flex: 1; padding: 8px; background: #e9ecef; border: none; cursor: pointer; font-weight: 600; color: #666; }
        .btn-tab-sig.active { background: #2c3e50; color: white; }

        /* PREVIEW */
        .preview-card { background: white; border: 1px solid var(--border); border-radius: 10px; padding: 20px; margin-top: 25px; display: none; box-shadow: 0 10px 20px rgba(0,0,0,0.05); }
        .preview-item { border-bottom: 1px dashed #eee; padding: 10px 0; font-size: 0.9rem; }
        
        .weight-alert { display: none; margin-top: 10px; background: #fff3cd; color: #856404; padding: 10px; border-radius: 6px; font-size: 0.85rem; border: 1px solid #ffeeba; }

        /* --- PDF PRINT STYLE --- */
        #print-area { display: none; }
        @page { size: A4; margin: 1.5cm; }
        
        @media print {
            body { background: white; margin: 0; padding: 0; }
            .container { display: none; }
            #print-area { display: block; width: 100%; font-family: 'Times New Roman', serif; color: #000; }
            
            .p-header { display: flex; justify-content: space-between; align-items: flex-end; border-bottom: 2px solid #000; padding-bottom: 10px; margin-bottom: 30px; }
            .p-title { font-size: 24px; font-weight: bold; margin: 0; text-transform: uppercase; }
            .p-meta { text-align: right; font-size: 12px; }
            
            .p-box { border: 1px solid #000; padding: 10px; margin-bottom: 25px; font-size: 14px; border-radius: 4px; }
            
            .p-list-title { text-align: center; font-size: 16px; font-weight: bold; text-decoration: underline; margin-bottom: 20px; text-transform: uppercase; }
            .p-item { margin-bottom: 20px; page-break-inside: avoid; }
            .p-med-header { font-weight: bold; font-size: 15px; }
            .p-med-sub { font-size: 12px; font-style: italic; }
            .p-med-body { margin-left: 20px; font-size: 14px; margin-top: 4px; line-height: 1.4; }
            
            .p-sig-block { margin-top: 50px; text-align: center; page-break-inside: avoid; width: 300px; margin-left: auto; margin-right: auto; }
            .p-sig-img { width: 180px; display: block; margin: 0 auto 5px auto; }
            .p-sig-line { border-top: 1px solid #000; width: 220px; margin: 0 auto 5px auto; }
            .p-vet-name { font-weight: bold; font-size: 14px; text-transform: uppercase; }
            .p-vet-crmv { font-size: 12px; }

            .p-footer-bar { position: fixed; bottom: 0; left: 0; right: 0; text-align: center; background: white; padding-top: 10px; }
            .p-footer-contact { font-size: 11px; color: #333; margin-bottom: 5px; font-weight: bold; }
            .p-footer-legal { font-size: 9px; color: #666; border-top: 1px solid #ccc; padding-top: 5px; font-style: italic; }
        }
    </style>
</head>
<body>

<div class="container">
    <div class="app-header">
        <h2>üè• VetManager <small style="font-size:0.7em">v19.0</small></h2>
        <button class="btn-reset" onclick="resetAll()">Limpar</button>
    </div>

    <div class="nav-tabs">
        <div class="nav-item active" onclick="switchTab('cadastro')">Prescri√ß√£o</div>
        <div class="nav-item" onclick="switchTab('config')">M√©dico & Assinatura</div>
    </div>

    <div id="tab-cadastro" class="tab-content active">
        <div id="sigStatusOk" class="sig-status-box">‚úÖ Assinatura Digital Carregada</div>
        <div id="sigStatusFail" class="sig-status-box missing">‚ö†Ô∏è Assinatura n√£o configurada (V√° em 'M√©dico')</div>

        <div class="section-label">1. Paciente</div>
        <input type="text" id="tutor" placeholder="Nome do Tutor">
        <div class="row">
            <input type="text" id="animal" placeholder="Nome do Animal" class="col">
            <select id="sexo" style="width: 100px;">
                <option value="Macho">Macho</option>
                <option value="F√™mea">F√™mea</option>
            </select>
        </div>
        
        <div class="row">
            <input type="text" id="raca" placeholder="Ra√ßa (Ex: Poodle)" class="col">
            <input type="text" id="idade" placeholder="Idade (Ex: 5 anos)" class="col">
        </div>

        <div class="row">
            <select id="especie" class="col" onchange="checkWeight()">
                <option value="canino">üê∂ C√£o</option>
                <option value="felino">üê± Gato</option>
            </select>
            <input type="number" id="peso" placeholder="Peso (kg)" class="col" step="0.1" oninput="checkWeight()">
        </div>
        <div id="weightAlert" class="weight-alert">‚ö†Ô∏è <strong>Peso > 20kg:</strong> Prefer√™ncia por via Oral.</div>

        <div class="section-label">2. Diagn√≥stico</div>
        <div class="symptoms-list" id="listaSintomas"></div>

        <div class="section-label">3. Manual</div>
        <div class="manual-box">
            <input type="text" id="manualPat" placeholder="Diagn√≥stico">
            <textarea id="manualMed" rows="2" style="margin-top:5px" placeholder="Tratamento"></textarea>
        </div>

        <button class="btn btn-calc" onclick="calcular()">üöÄ Calcular</button>
        
        <div id="previewArea" class="preview-card">
            <div style="text-align:center; font-weight:bold; border-bottom:1px solid #eee; padding-bottom:10px;">RESUMO</div>
            <div id="previewList"></div>
            <button class="btn btn-print" onclick="imprimir()">üìÑ Gerar PDF & Compartilhar</button>
        </div>
    </div>

    <div id="tab-config" class="tab-content">
        <div class="section-label">Dados Profissionais</div>
        <input type="text" id="vetNome" placeholder="Nome Completo (Dr. ...)">
        <input type="text" id="vetCRMV" placeholder="CRMV / UF" style="margin-top:10px">
        <input type="email" id="vetEmail" placeholder="E-mail" style="margin-top:10px">
        <input type="text" id="vetContato" placeholder="Telefone / WhatsApp" style="margin-top:10px">

        <div class="section-label" style="margin-top:30px">Gerenciar Assinatura</div>
        <div class="sig-manager">
            <div style="display:flex; gap:10px; margin-bottom:10px;">
                <button class="btn-tab-sig active" onclick="toggleSigMode('draw')" id="btnDraw">‚úçÔ∏è Desenhar</button>
                <button class="btn-tab-sig" onclick="toggleSigMode('upload')" id="btnUpload">üìÅ Upload</button>
            </div>

            <div id="modeDraw">
                <div class="canvas-wrapper">
                    <canvas id="sigCanvas"></canvas>
                </div>
                <div style="margin-top:10px; display:flex; justify-content:space-between;">
                    <button class="btn-mini" onclick="limparCanvas()" style="background:#e74c3c;">Limpar</button>
                    <button class="btn-mini" onclick="salvarCanvas()" style="background:#27ae60; padding:8px 15px;">üíæ Salvar Desenho</button>
                </div>
            </div>

            <div id="modeUpload" style="display:none; text-align:center;">
                <p style="font-size:0.8rem; color:#666;">Use PNG Transparente (Fundo Branco)<br>Ideal: 600x300px</p>
                <input type="file" id="stampInput" accept="image/*" onchange="handleImageUpload()">
            </div>

            <div style="margin-top:20px; border-top:1px solid #eee; pt:10px; text-align:center;">
                <p style="font-size:0.8rem; font-weight:bold;">Assinatura Atual Salva:</p>
                <img id="sigPreview" style="max-height:60px; border:1px solid #eee; display:none; margin:0 auto;">
                <button class="btn-mini" onclick="removerAssinatura()" style="margin-top:5px; background:#666;">üóëÔ∏è Apagar Assinatura</button>
            </div>
        </div>

        <button class="btn btn-save" onclick="salvarDadosTexto()">üíæ Salvar Dados de Texto</button>
    </div>
</div>

<div id="print-area">
    <div class="p-header">
        <h1 class="p-title">RECEITU√ÅRIO VETERIN√ÅRIO</h1>
        <div class="p-meta"><div id="pDataHora"></div></div>
    </div>
    <div class="p-box">
        <strong>Tutor:</strong> <span id="pTutor"></span> | <strong>Paciente:</strong> <span id="pAnimal"></span> (<span id="pEspecie"></span> / <span id="pSexo"></span>)<br>
        <strong>Ra√ßa:</strong> <span id="pRaca"></span> | <strong>Idade:</strong> <span id="pIdade"></span> | <strong>Peso:</strong> <span id="pPeso"></span> kg
    </div>
    <div class="p-list-title">Prescri√ß√£o Terap√™utica</div>
    <div id="pLista"></div>
    
    <div class="p-sig-block">
        <img id="pStampImg" class="p-sig-img">
        <div class="p-sig-line"></div>
        <div class="p-vet-name" id="pVetName"></div>
        <div class="p-vet-crmv" id="pVetCRMV"></div>
    </div>

    <div class="p-footer-bar">
        <div class="p-footer-contact" id="pFooterInfo"></div>
        <div class="p-footer-legal" id="pFooterLegal"></div>
    </div>
</div>

<script>
    /* BANCO DE DADOS */
    const database = [
        { cat: "ANTIMICROBIANOS", id: 1, p: "Infec√ß√£o Pele", brand: "Rilexine / Keflex", salt: "Cefalexina", d: 30, c: 50, u: "ml", a: "Susp. 250mg/5ml", f: "12/12h", t: "14-21 dias" },
        { cat: "ANTIMICROBIANOS", id: 2, p: "Infec√ß√£o Urin√°ria", brand: "Synulox", salt: "Amox.+Clavulanato", d: 12.5, c: 50, u: "ml", a: "Susp. 250mg/5ml", f: "12/12h", t: "10-14 dias" },
        { cat: "ANTIMICROBIANOS", id: 3, p: "Respirat√≥rio", brand: "Doxitec", salt: "Doxiciclina", d: 10, c: 80, u: "comp", a: "Comp 80mg", f: "24/24h", t: "14-21 dias" },
        { cat: "ANTIMICROBIANOS", id: 4, p: "Giard√≠ase", brand: "Giardicid", salt: "Metronidazol+Sulf.", d: 15, c: 50, u: "ml", a: "Susp. 50mg/ml", f: "12/12h", t: "5-7 dias" },
        { cat: "ANTIMICROBIANOS", id: 6, p: "Estomatite", brand: "Stomorgyl 10", salt: "Espiramicina+Metro.", d: 20, c: 1, u: "comp", a: "1 comp p/ 10kg", f: "24/24h", t: "10 dias" },

        { cat: "DOR E INFLAMA√á√ÉO", id: 7, p: "Dor Articular", brand: "Maxicam", salt: "Meloxicam", dog: 0.1, fel: 0.05, c: 0.5, u: "ml", a: "Sol. 0,5mg/ml", f: "24/24h", t: "3-4 dias" },
        { cat: "DOR E INFLAMA√á√ÉO", id: 8, p: "Dor Forte", brand: "Tramadol", salt: "Tramadol", d: 3, c: 50, u: "comp", a: "Comp 50mg", f: "8/8h", t: "3-5 dias" },
        { cat: "DOR E INFLAMA√á√ÉO", id: 9, p: "Febre / Dor", brand: "Dipirona", salt: "Dipirona S√≥dica", d: 25, c: 500, u: "ml", a: "Gotas 500mg/ml", f: "6/6h", t: "Se dor" },
        { cat: "DOR E INFLAMA√á√ÉO", id: 10, p: "Alergia / Coceira", brand: "Prediderm", salt: "Prednisolona", d: 0.5, c: 5, u: "comp", a: "Comp 5mg", f: "24/24h", t: "5-7 dias" },

        { cat: "GASTROINTESTINAL", id: 12, p: "V√¥mito", brand: "Vonau Vet", salt: "Ondansetrona", d: 0.5, c: 2, u: "ml", a: "2mg/ml", f: "8/8h", t: "Se v√¥mito" },
        { cat: "GASTROINTESTINAL", id: 14, p: "Prote√ß√£o G√°strica", brand: "Gaviz", salt: "Omeprazol", d: 1, c: 10, u: "comp", a: "Comp 10mg", f: "24/24h", t: "Jejum" },
        { cat: "GASTROINTESTINAL", id: 15, p: "Diarreia", brand: "Probi√≥tico", salt: "Lactobacillus", d: 1, c: 1, u: "ml", a: "Pasta", f: "24/24h", t: "3-5 dias" },

        { cat: "OUTROS", id: 16, p: "Verminose", brand: "Drontal", salt: "Praziquantel+", d: 1, c: 10, u: "comp", a: "1 comp p/ 10kg", f: "Dose √önica", t: "Repetir 15d" },
        { cat: "OUTROS", id: 17, p: "Sarna / Pulga", brand: "Simparic", salt: "Isoxazolina", d: 1, c: 1, u: "comp", a: "Conforme Peso", f: "Dose √önica", t: "Mensal" },
        { cat: "OUTROS", id: 22, p: "Limpeza Ouvido", brand: "Clean Up", salt: "Ceruminol√≠tico", d: 1, c: 1, u: "ml", a: "Solu√ß√£o", f: "24/24h", t: "Antes med." }
    ];

    /* APP CORE */
    const canvas = document.getElementById('sigCanvas');
    const ctx = canvas.getContext('2d');
    let drawing = false;

    window.onload = () => {
        carregarConfig();
        gerarLista();
        checkSigStatus();
        setupCanvas();
    };

    function gerarLista() {
        const div = document.getElementById('listaSintomas');
        div.innerHTML = "";
        const grouped = database.reduce((acc, curr) => { (acc[curr.cat] = acc[curr.cat] || []).push(curr); return acc; }, {});
        
        for (const [cat, items] of Object.entries(grouped)) {
            div.innerHTML += `<div class="cat-header">${cat}</div>`;
            items.forEach(item => {
                div.innerHTML += `
                    <label class="symptom-item">
                        <input type="checkbox" value="${item.id}" onchange="toggleSelect(this)">
                        <div class="pat-info">
                            <span class="pat-name">${item.p}</span>
                            <span class="med-name">üíä ${item.brand}</span>
                            <span class="med-detail">${item.salt}</span>
                        </div>
                    </label>
                `;
            });
        }
    }

    function toggleSelect(el) { el.closest('.symptom-item').classList.toggle('selected', el.checked); }

    function formatDose(val, type, nome) {
        if(type !== 'ml') {
            const dec = val - Math.floor(val);
            if(dec < 0.1 || dec > 0.9) return Math.round(val) + " comp";
            if(val <= 0.25) return "1/4 comp";
            if(val <= 0.6) return "1/2 comp";
            if(val <= 0.85) return "3/4 comp";
            return Math.ceil(val) + " comp";
        }
        let vol = val < 0.1 ? 0.1 : (val < 3 ? Math.round(val*10)/10 : (val <= 10 ? Math.round(val*5)/5 : (Math.round(val*2)/2).toFixed(1)));
        if(typeof vol === 'number') vol = vol % 1 === 0 ? vol.toFixed(0) : vol.toFixed(1);
        let txt = vol + " ml";
        if(val < 3 && (nome.includes("Dipirona") || nome.includes("Vonau"))) txt += ` (~${Math.round(val*20)} gts)`;
        return txt;
    }

    /* GEST√ÉO DE ASSINATURA */
    function toggleSigMode(mode) {
        document.getElementById('btnDraw').classList.toggle('active', mode === 'draw');
        document.getElementById('btnUpload').classList.toggle('active', mode === 'upload');
        document.getElementById('modeDraw').style.display = mode === 'draw' ? 'block' : 'none';
        document.getElementById('modeUpload').style.display = mode === 'upload' ? 'block' : 'none';
        if(mode === 'draw') setTimeout(resizeCanvas, 100);
    }

    function checkSigStatus() {
        const sig = localStorage.getItem('vetSignature');
        if(sig) {
            document.getElementById('sigStatusOk').style.display = 'block';
            document.getElementById('sigStatusFail').style.display = 'none';
            document.getElementById('sigPreview').src = sig;
            document.getElementById('sigPreview').style.display = 'block';
        } else {
            document.getElementById('sigStatusOk').style.display = 'none';
            document.getElementById('sigStatusFail').style.display = 'block';
            document.getElementById('sigPreview').style.display = 'none';
        }
    }

    function salvarCanvas() {
        const dataUrl = canvas.toDataURL();
        localStorage.setItem('vetSignature', dataUrl);
        alert("Assinatura Desenhada Salva!");
        checkSigStatus();
    }

    function handleImageUpload() {
        const file = document.getElementById('stampInput').files[0];
        if(!file) return;
        const reader = new FileReader();
        reader.onload = function(e) {
            localStorage.setItem('vetSignature', e.target.result);
            alert("Assinatura por Upload Salva!");
            checkSigStatus();
        }
        reader.readAsDataURL(file);
    }

    function removerAssinatura() {
        localStorage.removeItem('vetSignature');
        checkSigStatus();
        limparCanvas();
    }

    /* CALCULO E PRINT */
    let cacheRx = [];
    function calcular() {
        const peso = parseFloat(document.getElementById('peso').value);
        const esp = document.getElementById('especie').value;
        const checks = document.querySelectorAll('#listaSintomas input:checked');
        const manPat = document.getElementById('manualPat').value;
        const manMed = document.getElementById('manualMed').value;

        if(!peso && checks.length > 0) { alert("Informe o Peso!"); return; }
        if((!peso || checks.length === 0) && !manPat) { alert("Preencha Peso e Selecione Diagn√≥stico"); return; }

        cacheRx = [];
        const prev = document.getElementById('previewList');
        prev.innerHTML = "";

        checks.forEach(chk => {
            const m = database.find(p => p.id == chk.value);
            let doseFinal = m.a; 
            if(!m.brand.includes("Simparic") && !m.brand.includes("Drontal") && !m.brand.includes("Probi√≥tico") && !m.brand.includes("Stomorgyl")) {
                let doseBase = m.d;
                if(m.brand.includes('Maxicam')) doseBase = (esp === 'canino') ? m.dog : m.fel;
                const qtd = (peso * doseBase) / m.c;
                doseFinal = formatDose(qtd, m.u, m.brand);
            }
            let via = (esp === 'canino' && peso > 20) ? "VIA ORAL (Preferencial)" : "via oral";
            cacheRx.push({ brand: m.brand, salt: m.salt, a: m.a, dose: doseFinal, freq: m.f, dur: m.t, via: via });
            prev.innerHTML += `<div class="preview-item"><strong>${m.brand}</strong>: ${doseFinal} (${m.f})</div>`;
        });

        if(manPat && manMed) {
            cacheRx.push({ brand: "Manual", salt: manPat, a: "Personalizado", dose: manMed, freq: "", dur: "", via: "" });
            prev.innerHTML += `<div class="preview-item"><strong>${manPat}</strong> (Manual)</div>`;
        }

        const now = new Date();
        const animal = (document.getElementById('animal').value || 'SemNome').replace(/[^a-z0-9]/gi, '');
        document.title = `${now.getFullYear()}-${(now.getMonth()+1).toString().padStart(2,'0')}-${now.getDate().toString().padStart(2,'0')}_Receita_${animal}`;

        document.getElementById('previewArea').style.display = 'block';
        document.getElementById('previewArea').scrollIntoView({behavior:'smooth'});
    }

    function imprimir() {
        const now = new Date();
        document.getElementById('pDataHora').innerText = `${now.toLocaleDateString('pt-BR')} √†s ${now.toLocaleTimeString('pt-BR', {hour:'2-digit', minute:'2-digit'})}`;
        document.getElementById('pTutor').innerText = document.getElementById('tutor').value;
        document.getElementById('pAnimal').innerText = document.getElementById('animal').value;
        document.getElementById('pEspecie').innerText = document.getElementById('especie').value;
        document.getElementById('pSexo').innerText = document.getElementById('sexo').value;
        
        // NOVOS CAMPOS NO PDF
        document.getElementById('pRaca').innerText = document.getElementById('raca').value || 'N√£o inf.';
        document.getElementById('pIdade').innerText = document.getElementById('idade').value || 'N√£o inf.';
        document.getElementById('pPeso').innerText = document.getElementById('peso').value;

        const pl = document.getElementById('pLista');
        pl.innerHTML = "";
        cacheRx.forEach((m, i) => {
            if(m.a === "Personalizado") {
                pl.innerHTML += `<div class="p-item"><div class="p-med-header">${i+1}. ${m.salt} (Manual)</div><div class="p-med-body" style="white-space: pre-wrap;">${m.dose}</div></div>`;
            } else {
                pl.innerHTML += `<div class="p-item"><div class="p-med-header">${i+1}. ${m.brand} <small style="font-weight:normal">(${m.a})</small></div><div class="p-med-sub">Princ√≠pio: ${m.salt}</div><div class="p-med-body"><strong>Administrar:</strong> ${m.dose} ${m.via}.<br><strong>Posologia:</strong> ${m.freq} durante ${m.dur}.</div></div>`;
            }
        });

        // RODAP√â
        document.getElementById('pVetName').innerText = localStorage.getItem('vetNome');
        document.getElementById('pVetCRMV').innerText = localStorage.getItem('vetCRMV');
        const sig = localStorage.getItem('vetSignature');
        document.getElementById('pStampImg').src = sig ? sig : '';
        document.getElementById('pStampImg').style.display = sig ? 'block' : 'none';

        document.getElementById('pFooterInfo').innerText = `${localStorage.getItem('vetNome')} | ${localStorage.getItem('vetCRMV')} | ${localStorage.getItem('vetEmail')||''} | ${localStorage.getItem('vetContato')||''}`;
        document.getElementById('pFooterLegal').innerText = `Documento assinado digitalmente em ${now.toLocaleString('pt-BR')}. A veracidade deste documento pode ser verificada junto ao emissor.`;

        window.print();
    }

    /* CONFIG & CANVAS */
    function checkWeight() {
        const p = parseFloat(document.getElementById('peso').value);
        const e = document.getElementById('especie').value;
        document.getElementById('weightAlert').style.display = (e === 'canino' && p > 20) ? 'block' : 'none';
    }
    function resetAll() { 
        if(confirm("Limpar tudo?")) {
            document.querySelectorAll('input').forEach(i => i.value = '');
            document.querySelectorAll('textarea').forEach(i => i.value = '');
            document.querySelectorAll('input[type=checkbox]').forEach(el => {
                el.checked = false;
                el.closest('.symptom-item').classList.remove('selected');
            });
            document.getElementById('previewArea').style.display = 'none';
        }
    }
    
    function switchTab(t){ 
        document.querySelectorAll('.tab-content').forEach(c=>c.classList.remove('active')); 
        document.querySelectorAll('.nav-item').forEach(n=>n.classList.remove('active')); 
        document.getElementById('tab-'+t).classList.add('active'); 
        document.querySelectorAll('.nav-item')[t==='cadastro'?0:1].classList.add('active'); 
        if(t==='config') { setTimeout(resizeCanvas, 200); }
    }
    
    function salvarDadosTexto(){ 
        localStorage.setItem('vetNome',document.getElementById('vetNome').value); 
        localStorage.setItem('vetCRMV',document.getElementById('vetCRMV').value); 
        localStorage.setItem('vetEmail',document.getElementById('vetEmail').value); 
        localStorage.setItem('vetContato',document.getElementById('vetContato').value); 
        alert("Dados Salvos!"); 
    }
    function carregarConfig(){ 
        document.getElementById('vetNome').value=localStorage.getItem('vetNome')||""; 
        document.getElementById('vetCRMV').value=localStorage.getItem('vetCRMV')||""; 
        document.getElementById('vetEmail').value=localStorage.getItem('vetEmail')||""; 
        document.getElementById('vetContato').value=localStorage.getItem('vetContato')||""; 
    }
    
    // Canvas Engine
    function setupCanvas(){
        ['mousedown','touchstart'].forEach(e=>canvas.addEventListener(e, startDraw, {passive: false}));
        ['mouseup','touchend'].forEach(e=>canvas.addEventListener(e, endDraw, {passive: false}));
        ['mousemove','touchmove'].forEach(e=>canvas.addEventListener(e, draw, {passive: false}));
    }
    function resizeCanvas(){
        const p=canvas.parentElement;
        if(p.clientWidth) {
            canvas.width = p.clientWidth;
            canvas.height = p.clientHeight;
            ctx.lineWidth=2;
            ctx.strokeStyle="#000080";
        }
    }
    function startDraw(e){ drawing=true; ctx.beginPath(); draw(e); }
    function endDraw(){ drawing=false; ctx.beginPath(); }
    function draw(e){ 
        if(!drawing) return; 
        e.preventDefault(); 
        const rect = canvas.getBoundingClientRect();
        const clientX = e.touches ? e.touches[0].clientX : e.clientX;
        const clientY = e.touches ? e.touches[0].clientY : e.clientY;
        ctx.lineTo(clientX - rect.left, clientY - rect.top);
        ctx.stroke(); 
    }
    function limparCanvas(){ ctx.clearRect(0,0,canvas.width,canvas.height); }
</script>
</body>
</html>
