<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>VetManager v15.0 (RC)</title>
    <style>
        /* --- DESIGN SYSTEM REFINADO --- */
        :root {
            --primary: #27ae60;
            --primary-dark: #219150;
            --secondary: #2c3e50;
            --accent: #2980b9;
            --bg: #f8f9fa;
            --card: #ffffff;
            --border: #dee2e6;
            --text: #343a40;
            --text-light: #6c757d;
        }

        body { font-family: 'Inter', 'Segoe UI', sans-serif; background-color: var(--bg); margin: 0; padding-bottom: 100px; color: var(--text); -webkit-font-smoothing: antialiased; }
        .container { max-width: 600px; margin: 0 auto; background: var(--card); min-height: 100vh; box-shadow: 0 0 30px rgba(0,0,0,0.03); }

        /* HEADER */
        .app-header { background: var(--secondary); color: white; padding: 15px 20px; display: flex; justify-content: space-between; align-items: center; }
        .app-header h2 { margin: 0; font-size: 1.1rem; font-weight: 600; letter-spacing: 0.5px; }
        .btn-reset-all { background: transparent; border: 1px solid rgba(255,255,255,0.3); color: white; font-size: 0.75rem; padding: 5px 10px; border-radius: 4px; cursor: pointer; }

        /* TABS */
        .nav-tabs { display: flex; background: #34495e; position: sticky; top: 0; z-index: 99; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .nav-item { flex: 1; padding: 15px; text-align: center; color: #aab0b6; cursor: pointer; border-bottom: 3px solid transparent; font-weight: 600; font-size: 0.85rem; text-transform: uppercase; transition: 0.2s; }
        .nav-item.active { color: white; border-bottom-color: var(--primary); background: #2b3b4b; }
        
        .tab-content { display: none; padding: 20px; animation: fadeIn 0.3s ease; }
        .tab-content.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        /* FORMUL√ÅRIO */
        .section-label { color: var(--accent); font-size: 0.8rem; font-weight: 800; text-transform: uppercase; margin-top: 20px; margin-bottom: 8px; letter-spacing: 0.5px; display: flex; align-items: center; gap: 5px; }
        .section-label:first-child { margin-top: 0; }
        
        input, select, textarea { width: 100%; padding: 12px; border: 1px solid #ced4da; border-radius: 6px; font-size: 16px; box-sizing: border-box; font-family: inherit; transition: border 0.2s; background: #fff; }
        input:focus, select:focus, textarea:focus { border-color: var(--primary); outline: none; box-shadow: 0 0 0 3px rgba(39, 174, 96, 0.1); }
        
        .row { display: flex; gap: 10px; margin-top: 10px; }
        .col { flex: 1; }

        /* LISTA CL√çNICA (CORRIGIDA) */
        .symptoms-list { height: 400px; overflow-y: auto; background: #fff; border: 1px solid var(--border); border-radius: 8px; margin-top: 5px; }
        .cat-header { background: #e9ecef; color: var(--text-light); font-size: 0.7rem; font-weight: 700; text-transform: uppercase; padding: 8px 15px; position: sticky; top: 0; z-index: 1; border-bottom: 1px solid var(--border); letter-spacing: 0.5px; }
        
        .symptom-item { display: flex; align-items: flex-start; padding: 12px 15px; border-bottom: 1px solid #f1f3f5; cursor: pointer; transition: background 0.1s; }
        .symptom-item:last-child { border-bottom: none; }
        .symptom-item.selected { background-color: #e8f5e9; }
        
        .symptom-item input { width: 20px; height: 20px; margin: 2px 15px 0 0; accent-color: var(--primary); cursor: pointer; flex-shrink: 0; }
        .pat-info { display: flex; flex-direction: column; }
        .pat-name { font-size: 0.9rem; font-weight: 700; color: var(--text); }
        .med-name { font-size: 0.8rem; color: var(--primary-dark); font-weight: 600; margin-top: 2px; }
        .med-detail { font-size: 0.75rem; color: var(--text-light); font-weight: normal; }

        /* MANUAL ENTRY */
        .manual-box { background: #fff; border: 1px dashed #ced4da; padding: 15px; border-radius: 8px; margin-top: 5px; }

        /* ALERTAS */
        .alert { padding: 10px; border-radius: 6px; font-size: 0.85rem; margin-top: 10px; display: none; align-items: center; gap: 8px; }
        .alert-warning { background: #fff3cd; color: #856404; border: 1px solid #ffeeba; }
        .alert-success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; text-align: center; }

        /* BOTOES */
        .btn { width: 100%; padding: 15px; margin-top: 20px; border: none; border-radius: 8px; font-size: 1rem; font-weight: 700; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 10px; transition: transform 0.1s; text-transform: uppercase; letter-spacing: 0.5px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); }
        .btn:active { transform: scale(0.98); }
        .btn-calc { background: var(--primary); color: white; }
        .btn-print { background: var(--accent); color: white; margin-top: 15px; }
        .btn-config { background: var(--secondary); color: white; margin-top: 20px; }
        .btn-mini { padding: 6px 12px; font-size: 0.75rem; border-radius: 4px; border: none; cursor: pointer; }
        .btn-danger { background: #e74c3c; color: white; }

        /* PREVIEW */
        .preview-card { background: white; border: 1px solid var(--border); border-radius: 10px; padding: 20px; margin-top: 25px; display: none; box-shadow: 0 10px 20px rgba(0,0,0,0.05); }
        .preview-title { font-size: 0.9rem; font-weight: 700; color: var(--secondary); text-align: center; border-bottom: 1px solid #eee; padding-bottom: 10px; margin-bottom: 15px; text-transform: uppercase; }
        .preview-item { border-bottom: 1px dashed #eee; padding: 10px 0; font-size: 0.9rem; color: var(--text); }
        .preview-item:last-child { border-bottom: none; }

        /* CONFIGURA√á√ïES */
        .stamp-area { border: 2px dashed #ced4da; padding: 20px; text-align: center; border-radius: 8px; background: #f8f9fa; margin-top: 5px; }
        .stamp-img-preview { max-height: 80px; margin-top: 10px; display: none; border: 1px solid #ddd; }
        
        .signature-wrapper { border: 2px dashed #ced4da; height: 120px; background: #fff; border-radius: 8px; position: relative; margin-top: 5px; }
        canvas { width: 100%; height: 100%; cursor: crosshair; }
        .sig-placeholder { position: absolute; top: 10px; left: 10px; color: #adb5bd; font-size: 0.75rem; pointer-events: none; }

        /* --- IMPRESS√ÉO (PDF) --- */
        #print-area { display: none; }
        @page { size: A4; margin: 1.5cm; }
        
        @media print {
            body { background: white; margin: 0; padding: 0; }
            .container { display: none; }
            
            #print-area { display: block; width: 100%; font-family: 'Times New Roman', serif; color: #000; }
            
            .p-header { display: flex; justify-content: space-between; align-items: flex-end; border-bottom: 2px solid #000; padding-bottom: 15px; margin-bottom: 30px; }
            .p-vet-info h1 { font-size: 22px; margin: 0; text-transform: uppercase; }
            .p-vet-info p { margin: 5px 0 0 0; font-size: 14px; }
            .p-meta { text-align: right; font-size: 12px; }
            
            .p-box { border: 1px solid #000; padding: 10px; margin-bottom: 25px; font-size: 14px; border-radius: 4px; }
            .p-title { text-align: center; font-size: 18px; font-weight: bold; text-decoration: underline; margin-bottom: 30px; text-transform: uppercase; }
            
            .p-item { margin-bottom: 20px; page-break-inside: avoid; }
            .p-med-line1 { font-weight: bold; font-size: 16px; display: flex; justify-content: space-between; }
            .p-med-line2 { font-size: 14px; font-style: italic; margin-top: 2px; }
            .p-med-line3 { margin-left: 20px; font-size: 14px; margin-top: 5px; line-height: 1.4; }
            
            .p-footer { margin-top: 50px; text-align: center; page-break-inside: avoid; }
            .p-stamp { width: 200px; display: block; margin: 0 auto 5px auto; }
            .p-line { border-top: 1px solid #000; width: 250px; margin: 0 auto; }
            .p-legal { font-size: 10px; color: #555; text-align: center; margin-top: 30px; border-top: 1px solid #ccc; padding-top: 5px; }
        }
    </style>
</head>
<body>

<div class="container">
    <div class="app-header">
        <h2>üè• VetManager <small style="opacity:0.7">v15.0</small></h2>
        <button class="btn-reset-all" onclick="resetAll()">Limpar Tudo</button>
    </div>

    <div class="nav-tabs">
        <div class="nav-item active" onclick="switchTab('cadastro')">Prescri√ß√£o</div>
        <div class="nav-item" onclick="switchTab('config')">Configura√ß√£o</div>
    </div>

    <div id="tab-cadastro" class="tab-content active">
        
        <div class="section-label">1. Paciente</div>
        <input type="text" id="tutor" placeholder="Nome do Tutor">
        <div class="row">
            <input type="text" id="animal" placeholder="Nome do Animal" class="col">
            <select id="sexo" style="width: 100px;">
                <option value="Macho">Macho</option>
                <option value="F√™mea">F√™mea</option>
            </select>
        </div>
        <div class="row">
            <select id="especie" class="col" onchange="checkWeight()">
                <option value="canino">üê∂ C√£o</option>
                <option value="felino">üê± Gato</option>
            </select>
            <input type="number" id="peso" placeholder="Peso (kg)" class="col" step="0.1" oninput="checkWeight()">
        </div>

        <div id="weightAlert" class="alert alert-warning">
            ‚ö†Ô∏è <strong>Peso > 20kg:</strong> Prefer√™ncia por via Oral.
        </div>

        <div class="section-label">2. Diagn√≥stico (Selecione)</div>
        <div class="symptoms-list" id="listaSintomas">
            </div>

        <div class="section-label">3. Manual / Adicional</div>
        <div class="manual-box">
            <input type="text" id="manualPat" placeholder="Diagn√≥stico (Ex: Otite)">
            <textarea id="manualMed" rows="2" style="margin-top:5px" placeholder="Tratamento (Ex: Natalene 3 gotas 12/12h...)"></textarea>
        </div>

        <div id="canvasArea" style="display:none; margin-top:20px;">
            <div class="section-label">4. Assinatura</div>
            <div class="signature-wrapper">
                <span class="sig-placeholder">Desenhe aqui...</span>
                <canvas id="sigCanvas"></canvas>
            </div>
            <button class="btn-mini btn-danger" style="float:right; margin-top:5px;" onclick="limparCanvas()">Limpar</button>
            <div style="clear:both"></div>
        </div>
        
        <div id="stampStatus" class="alert alert-success">
            ‚úÖ Carimbo Digital Carregado
        </div>

        <button class="btn btn-calc" onclick="calcular()">üöÄ Calcular</button>
        
        <div id="previewArea" class="preview-card">
            <div class="preview-title">Resumo da Receita</div>
            <div id="previewList"></div>
            
            <button class="btn btn-print" onclick="imprimir()">
                üìÑ Gerar PDF & Compartilhar
            </button>
            <div style="text-align:center; font-size:0.75rem; color:#999; margin-top:10px;">
                Nome do arquivo: Data_Hora_Receita_Nome.pdf
            </div>
        </div>
    </div>

    <div id="tab-config" class="tab-content">
        <div class="section-label">Dados do Veterin√°rio</div>
        <input type="text" id="vetNome" placeholder="Nome Completo">
        <input type="text" id="vetCRMV" placeholder="CRMV / UF" style="margin-top:10px">
        <input type="text" id="vetContato" placeholder="Telefone" style="margin-top:10px">

        <div class="section-label">Carimbo Digital</div>
        <div class="stamp-area">
            <p style="font-size:0.8rem; color:#666; margin:0 0 10px 0;">Use PNG Transparente (600x300px)</p>
            <input type="file" id="stampInput" accept="image/*" onchange="salvarCarimbo()">
            <img id="stampPreview" class="stamp-img-preview">
            <br>
            <button class="btn-mini btn-danger" style="margin-top:10px;" onclick="removerCarimbo()">Remover</button>
        </div>
        <button class="btn btn-config" onclick="salvarTexto()">üíæ Salvar Dados</button>
    </div>
</div>

<div id="print-area">
    <div class="p-header">
        <div class="p-vet-info">
            <h1 id="pNome">Dr. Veterin√°rio</h1>
            <p id="pCRMV">CRMV: ---</p>
        </div>
        <div class="p-meta">
            <span id="pContato"></span><br>
            Data: <span id="pData"></span>
        </div>
    </div>

    <div class="p-box">
        <strong>Tutor:</strong> <span id="pTutor"></span> | 
        <strong>Paciente:</strong> <span id="pAnimal"></span> (<span id="pEspecie"></span> / <span id="pSexo"></span>)<br>
        <strong>Peso:</strong> <span id="pPeso"></span> kg
    </div>

    <div class="p-title">RECEITU√ÅRIO VETERIN√ÅRIO</div>
    <div id="pLista"></div>

    <div class="p-footer">
        <img id="pStampImg" class="p-stamp">
        <div id="pLine" class="p-line" style="display:none;"></div>
        <div style="font-weight:bold" id="pNomeRodape">Dr. Veterin√°rio</div>
        <div class="p-legal" id="pTimestamp"></div>
    </div>
</div>

<script>
    /* BANCO DE DADOS VETERIN√ÅRIO (VET FIRST)
       p: Patologia (Diagn√≥stico)
       brand: Marca Veterin√°ria (Destaque)
       salt: Princ√≠pio Ativo + Apresenta√ß√£o
    */
    const database = [
        // Antibi√≥ticos
        { cat: "ANTIMICROBIANOS", id: 1, p: "Infec√ß√£o Pele (Piodermite)", brand: "Rilexine / Keflex", salt: "Cefalexina", d: 30, c: 50, u: "ml", a: "Susp. 250mg/5ml", f: "12/12h", t: "14 a 21 dias" },
        { cat: "ANTIMICROBIANOS", id: 2, p: "Infec√ß√£o Urin√°ria (Cistite)", brand: "Synulox / Agemoxi", salt: "Amox. + Clavulanato", d: 12.5, c: 50, u: "ml", a: "Susp. 250mg/5ml", f: "12/12h", t: "10 a 14 dias" },
        { cat: "ANTIMICROBIANOS", id: 3, p: "Infec√ß√£o Respirat√≥ria", brand: "Doxitec", salt: "Doxiciclina", d: 10, c: 80, u: "comp", a: "Comp 80mg", f: "24/24h", t: "14 a 21 dias" },
        { cat: "ANTIMICROBIANOS", id: 4, p: "Giard√≠ase / Ent√©rico", brand: "Giardicid", salt: "Metronidazol + Sulf.", d: 15, c: 50, u: "ml", a: "Susp. 50mg/ml", f: "12/12h", t: "5 a 7 dias" },
        { cat: "ANTIMICROBIANOS", id: 5, p: "Doen√ßa do Carrapato", brand: "Doxitec", salt: "Doxiciclina", d: 10, c: 80, u: "comp", a: "Comp 80mg", f: "24/24h", t: "28 dias" },
        { cat: "ANTIMICROBIANOS", id: 6, p: "Infec√ß√£o Bucal (Estomatite)", brand: "Stomorgyl 10", salt: "Espiramicina + Metro.", d: 20, c: 1, u: "comp", a: "1 comp p/ 10kg", f: "24/24h", t: "10 dias" },

        // Dor
        { cat: "DOR E INFLAMA√á√ÉO", id: 7, p: "Dor Articular / Muscular", brand: "Maxicam / Meloxivet", salt: "Meloxicam", dog: 0.1, cat: 0.05, c: 0.5, u: "ml", a: "Sol. 0,5mg/ml", f: "24/24h", t: "3 a 4 dias" },
        { cat: "DOR E INFLAMA√á√ÉO", id: 8, p: "Dor Forte / P√≥s-Op", brand: "Cronidor / Tramadol", salt: "Tramadol", d: 3, c: 50, u: "comp", a: "Comp. 50mg", f: "8/8h", t: "3 a 5 dias" },
        { cat: "DOR E INFLAMA√á√ÉO", id: 9, p: "Febre / Dor Simples", brand: "Novalgina / Dipirona", salt: "Dipirona S√≥dica", d: 25, c: 500, u: "ml", a: "Gotas 500mg/ml", f: "6/6h", t: "Se houver dor" },
        { cat: "DOR E INFLAMA√á√ÉO", id: 10, p: "Alergia / Coceira", brand: "Prediderm / Predsim", salt: "Prednisolona", d: 0.5, c: 5, u: "comp", a: "Comp. 5mg", f: "24/24h", t: "5 a 7 dias" },
        
        // Gastro
        { cat: "GASTROINTESTINAL", id: 12, p: "V√¥mito / Enjoo", brand: "Vonau Vet", salt: "Ondansetrona", d: 0.5, c: 2, u: "ml", a: "2mg/ml", f: "8/8h", t: "Se v√¥mito" },
        { cat: "GASTROINTESTINAL", id: 13, p: "V√¥mito / Motilidade", brand: "Plasil", salt: "Metoclopramida", d: 0.5, c: 4, u: "ml", a: "Gotas 4mg/ml", f: "8/8h", t: "Se v√¥mito" },
        { cat: "GASTROINTESTINAL", id: 14, p: "Prote√ß√£o G√°strica", brand: "Gaviz", salt: "Omeprazol", d: 1, c: 10, u: "comp", a: "Comp. 10mg", f: "24/24h", t: "Jejum" },
        { cat: "GASTROINTESTINAL", id: 15, p: "Diarreia", brand: "Probi√≥tico Vet", salt: "Lactobacillus", d: 1, c: 1, u: "ml", a: "Pasta", f: "24/24h", t: "3 a 5 dias" },

        // Outros
        { cat: "PARASITAS E OUTROS", id: 16, p: "Verminose", brand: "Drontal / Top Dog", salt: "Praziquantel+", d: 1, c: 10, u: "comp", a: "1 comp p/ 10kg", f: "Dose √önica", t: "Repetir 15 dias" },
        { cat: "PARASITAS E OUTROS", id: 17, p: "Sarna / Pulga", brand: "Simparic / Bravecto", salt: "Isoxazolina", d: 1, c: 1, u: "comp", a: "Conforme Peso", f: "Dose √önica", t: "Mensal/Trimestral" },
        { cat: "PARASITAS E OUTROS", id: 18, p: "Tosse", brand: "Fluimucil", salt: "Acetilciste√≠na", d: 10, c: 20, u: "ml", a: "Xarope 20mg/ml", f: "12/12h", t: "5 a 7 dias" },
        { cat: "PARASITAS E OUTROS", id: 19, p: "Fungos (Pele)", brand: "Cetoconazol", salt: "Cetoconazol", d: 10, c: 200, u: "comp", a: "Comp 200mg", f: "12/12h", t: "21 dias" },
        { cat: "PARASITAS E OUTROS", id: 20, p: "Card√≠aco / Diur√©tico", brand: "Lasix", salt: "Furosemida", d: 2, c: 40, u: "comp", a: "Comp 40mg", f: "12/12h", t: "Uso cont√≠nuo" },
        { cat: "PARASITAS E OUTROS", id: 21, p: "Seda√ß√£o / Transporte", brand: "Acepran", salt: "Acepromazina", d: 0.5, c: 10, u: "ml", a: "Gotas 10mg/ml", f: "Se necess√°rio", t: "40min antes" },
        { cat: "PARASITAS E OUTROS", id: 22, p: "Limpeza Ouvido", brand: "Clean Up / Epiotic", salt: "Ceruminol√≠tico", d: 1, c: 1, u: "ml", a: "Solu√ß√£o", f: "24/24h", t: "Antes do rem√©dio" }
    ];

    const canvas = document.getElementById('sigCanvas');
    const ctx = canvas.getContext('2d');
    let cacheRx = [];
    let originalTitle = document.title;

    window.onload = () => {
        carregarConfig();
        gerarLista();
        checarCarimbo();
        setupCanvas();
    };

    /* --- L√ìGICA DE INTERFACE --- */
    function resetAll() {
        if(confirm("Limpar todos os campos da prescri√ß√£o?")) {
            document.getElementById('tutor').value = "";
            document.getElementById('animal').value = "";
            document.getElementById('peso').value = "";
            document.getElementById('manualPat').value = "";
            document.getElementById('manualMed').value = "";
            document.getElementById('previewArea').style.display = 'none';
            document.querySelectorAll('input[type=checkbox]').forEach(el => {
                el.checked = false;
                el.closest('.symptom-item').classList.remove('selected');
            });
            limparCanvas();
            checkWeight();
        }
    }

    function checkWeight() {
        const peso = parseFloat(document.getElementById('peso').value);
        const especie = document.getElementById('especie').value;
        const alertBox = document.getElementById('weightAlert');
        if(especie === 'canino' && peso > 20) alertBox.style.display = 'block';
        else alertBox.style.display = 'none';
    }

    function toggleSelect(element) {
        if(element.checked) element.closest('.symptom-item').classList.add('selected');
        else element.closest('.symptom-item').classList.remove('selected');
    }

    function gerarLista() {
        const div = document.getElementById('listaSintomas');
        div.innerHTML = "";
        const grouped = database.reduce((acc, curr) => { (acc[curr.cat] = acc[curr.cat] || []).push(curr); return acc; }, {});
        
        for (const [cat, items] of Object.entries(grouped)) {
            div.innerHTML += `<div class="cat-header">${cat}</div>`;
            items.forEach(item => {
                div.innerHTML += `
                    <label class="symptom-item">
                        <input type="checkbox" value="${item.id}" onchange="toggleSelect(this)">
                        <div class="pat-info">
                            <span class="pat-name">${item.p}</span>
                            <span class="med-name">üíä ${item.brand}</span>
                            <span class="med-detail">(${item.salt} - ${item.a})</span>
                        </div>
                    </label>
                `;
            });
        }
    }

    /* --- C√ÅLCULO --- */
    function formatDose(val, type, nome) {
        if(type !== 'ml') {
            const dec = val - Math.floor(val);
            if(dec < 0.1 || dec > 0.9) return Math.round(val) + " comp";
            if(val <= 0.25) return "1/4 comp";
            if(val <= 0.6) return "1/2 comp";
            if(val <= 0.85) return "3/4 comp";
            return Math.ceil(val) + " comp";
        }
        let vol = val < 0.1 ? 0.1 : (val < 3 ? Math.round(val*10)/10 : (val <= 10 ? Math.round(val*5)/5 : (Math.round(val*2)/2).toFixed(1)));
        if(typeof vol === 'number') vol = vol % 1 === 0 ? vol.toFixed(0) : vol.toFixed(1);
        let txt = vol + " ml";
        if(val < 3 && (nome.includes("Dipirona") || nome.includes("Ondansetrona") || nome.includes("Acepran") || nome.includes("Plasil"))) txt += ` (~${Math.round(val*20)} gts)`;
        return txt;
    }

    function calcular() {
        const peso = parseFloat(document.getElementById('peso').value);
        const esp = document.getElementById('especie').value;
        const checks = document.querySelectorAll('#listaSintomas input:checked');
        const manPat = document.getElementById('manualPat').value;
        const manMed = document.getElementById('manualMed').value;

        // VALIDA√á√ÉO CR√çTICA DO PESO
        if(!peso && (checks.length > 0)) {
            alert("‚ö†Ô∏è Erro: Peso do animal √© obrigat√≥rio para o c√°lculo.");
            return;
        }

        if((!peso || checks.length === 0) && (!manPat || !manMed)) { 
            alert("Preencha o Peso e selecione uma Patologia."); return; 
        }

        cacheRx = [];
        const prev = document.getElementById('previewList');
        prev.innerHTML = "";

        checks.forEach(chk => {
            const m = database.find(p => p.id == chk.value);
            
            // L√≥gica Especial (Dose √önica ou Fixa)
            let doseFinal = "";
            if(m.brand.includes("Simparic") || m.brand.includes("Drontal") || m.brand.includes("Stomorgyl") || m.brand.includes("Probi√≥tico")) {
                doseFinal = m.a; // Usa a apresenta√ß√£o como dose
            } else {
                let doseBase = m.d;
                if(m.brand.includes('Maxicam')) doseBase = (esp === 'canino') ? m.dog : m.cat;
                
                const qtd = (peso * doseBase) / m.c;
                doseFinal = formatDose(qtd, m.u, m.brand);
            }
            
            let via = (esp === 'canino' && peso > 20) ? "VIA ORAL (Preferencial)" : "via oral";

            cacheRx.push({ brand: m.brand, salt: m.salt, a: m.a, dose: doseFinal, freq: m.f, dur: m.t, via: via });
            prev.innerHTML += `<div class="preview-item"><strong>${m.brand}</strong>: ${doseFinal}<br><small>${m.f}</small></div>`;
        });

        if(manPat && manMed) {
            cacheRx.push({ brand: "Protocolo Manual", salt: manPat, a: "Personalizado", dose: manMed, freq: "Conforme descrito", dur: "-", via: "-" });
            prev.innerHTML += `<div class="preview-item"><strong>${manPat}</strong><br><small>Personalizado</small></div>`;
        }

        // NOME DO ARQUIVO
        const now = new Date();
        const pad = (n) => n.toString().padStart(2, '0');
        const nomeAnimal = (document.getElementById('animal').value || 'SemNome').replace(/[^a-z0-9]/gi, '');
        const tipo = document.getElementById('especie').value === 'canino' ? 'Cao' : 'Gato';
        document.title = `${now.getFullYear()}-${pad(now.getMonth()+1)}-${pad(now.getDate())}_Receita_${tipo}-${nomeAnimal}`;

        document.getElementById('previewArea').style.display = 'block';
        document.getElementById('previewArea').scrollIntoView({behavior:'smooth'});
    }

    /* IMPRESS√ÉO */
    function imprimir() {
        const now = new Date();
        document.getElementById('pNome').innerText = localStorage.getItem('vetNome');
        document.getElementById('pCRMV').innerText = localStorage.getItem('vetCRMV');
        document.getElementById('pContato').innerText = localStorage.getItem('vetContato');
        document.getElementById('pData').innerText = now.toLocaleDateString('pt-BR');
        
        document.getElementById('pTutor').innerText = document.getElementById('tutor').value;
        document.getElementById('pAnimal').innerText = document.getElementById('animal').value;
        document.getElementById('pEspecie').innerText = document.getElementById('especie').value;
        document.getElementById('pSexo').innerText = document.getElementById('sexo').value;
        document.getElementById('pPeso').innerText = document.getElementById('peso').value;
        document.getElementById('pNomeRodape').innerText = localStorage.getItem('vetNome');
        document.getElementById('pTimestamp').innerText = `Gerado eletronicamente em: ${now.toLocaleString('pt-BR')}. Documento auxiliar de orienta√ß√£o terap√™utica.`;

        const pl = document.getElementById('pLista');
        pl.innerHTML = "";
        cacheRx.forEach((m, i) => {
            if(m.a === "Personalizado") {
                pl.innerHTML += `
                <div class="p-item">
                    <div class="p-med-line1"><span>${i+1}. ${m.salt}</span> <small>(Manual)</small></div>
                    <div class="p-med-line3" style="white-space: pre-wrap;">${m.dose}</div>
                </div>`;
            } else {
                pl.innerHTML += `
                <div class="p-item">
                    <div class="p-med-line1">
                        <span>${i+1}. ${m.brand} <small>(${m.a})</small></span>
                    </div>
                    <div class="p-med-line2">Princ√≠pio: ${m.salt}</div>
                    <div class="p-med-line3">
                        <strong>Administrar:</strong> ${m.dose} ${m.via}.<br>
                        <strong>Posologia:</strong> ${m.freq} durante ${m.dur}.
                    </div>
                </div>`;
            }
        });

        const stamp = localStorage.getItem('vetStampImg');
        const img = document.getElementById('pStampImg');
        const line = document.getElementById('pLine');
        if(stamp) { img.src = stamp; img.style.display='block'; line.style.display='none'; }
        else { img.src = canvas.toDataURL(); img.style.display='block'; line.style.display='block'; }

        window.print();
        setTimeout(() => { document.title = "VetManager v15.0"; }, 2000);
    }

    /* SISTEMA DE CONFIGURA√á√ÉO E CANVAS */
    function switchTab(t){ document.querySelectorAll('.tab-content').forEach(c=>c.classList.remove('active')); document.querySelectorAll('.nav-item').forEach(n=>n.classList.remove('active')); document.getElementById('tab-'+t).classList.add('active'); document.querySelectorAll('.nav-item')[t==='cadastro'?0:1].classList.add('active'); if(t==='cadastro'){checarCarimbo();setTimeout(resizeCanvas,200);} }
    function salvarTexto(){ localStorage.setItem('vetNome',document.getElementById('vetNome').value); localStorage.setItem('vetCRMV',document.getElementById('vetCRMV').value); localStorage.setItem('vetContato',document.getElementById('vetContato').value); alert("Salvo!"); }
    function salvarCarimbo(){ const f=document.getElementById('stampInput').files[0]; if(!f)return; const r=new FileReader(); r.onloadend=()=>{localStorage.setItem('vetStampImg',r.result); checarCarimbo(); alert("Carimbo Salvo!");}; r.readAsDataURL(f); }
    function removerCarimbo(){ localStorage.removeItem('vetStampImg'); checarCarimbo(); }
    function carregarConfig(){ document.getElementById('vetNome').value=localStorage.getItem('vetNome')||""; document.getElementById('vetCRMV').value=localStorage.getItem('vetCRMV')||""; document.getElementById('vetContato').value=localStorage.getItem('vetContato')||""; }
    function checarCarimbo(){ if(localStorage.getItem('vetStampImg')){ document.getElementById('canvasArea').style.display='none'; document.getElementById('stampStatus').style.display='block'; }else{ document.getElementById('canvasArea').style.display='block'; document.getElementById('stampStatus').style.display='none'; } }
    
    let drawing=false;
    function setupCanvas(){ ['mousedown','touchstart'].forEach(e=>canvas.addEventListener(e,ds)); ['mouseup','touchend'].forEach(e=>canvas.addEventListener(e,de)); ['mousemove','touchmove'].forEach(e=>canvas.addEventListener(e,dd)); }
    function resizeCanvas(){ const p=canvas.parentElement; canvas.width=p.clientWidth; canvas.height=p.clientHeight; ctx.lineWidth=2; ctx.strokeStyle="#000080"; }
    function ds(e){ drawing=true; ctx.beginPath(); dd(e); }
    function de(){ drawing=false; ctx.beginPath(); }
    function dd(e){ if(!drawing)return; e.preventDefault(); const r=canvas.getBoundingClientRect(); const x=(e.touches?e.touches[0].clientX:e.clientX)-r.left; const y=(e.touches?e.touches[0].clientY:e.clientY)-r.top; ctx.lineTo(x,y); ctx.stroke(); }
    function limparCanvas(){ ctx.clearRect(0,0,canvas.width,canvas.height); }
</script>
</body>
</html>
