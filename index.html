<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>VetManager v14.0</title>
    <style>
        /* --- CORE CSS --- */
        :root { --primary: #27ae60; --dark: #2c3e50; --bg: #f4f7f6; --card: #ffffff; --border: #e1e4e8; }
        body { font-family: 'Segoe UI', system-ui, sans-serif; background: var(--bg); margin: 0; padding-bottom: 100px; -webkit-tap-highlight-color: transparent; color: #333; }
        .container { max-width: 650px; margin: 0 auto; background: var(--card); min-height: 100vh; box-shadow: 0 0 25px rgba(0,0,0,0.05); }

        /* HEADER */
        .app-header { background: var(--dark); color: white; padding: 15px; text-align: center; }
        .nav-tabs { display: flex; background: #34495e; position: sticky; top: 0; z-index: 100; }
        .nav-item { flex: 1; padding: 15px; text-align: center; color: #bdc3c7; cursor: pointer; border-bottom: 4px solid transparent; font-weight: bold; text-transform: uppercase; font-size: 0.85rem; transition: 0.3s; }
        .nav-item.active { color: white; border-bottom-color: var(--primary); background: #2c3e50; }
        .tab-content { display: none; padding: 20px; animation: fadeUp 0.3s ease; }
        .tab-content.active { display: block; }
        @keyframes fadeUp { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* FORM */
        .section-title { color: #2980b9; border-bottom: 2px solid #eee; padding-bottom: 8px; margin-top: 25px; font-weight: 800; display: flex; align-items: center; font-size: 0.95rem; text-transform: uppercase; }
        label { display: block; margin-top: 12px; font-weight: 600; color: #555; font-size: 0.9rem; }
        input, select, textarea { width: 100%; padding: 12px; margin-top: 5px; border: 1px solid #ccc; border-radius: 8px; box-sizing: border-box; font-size: 16px; background: #fff; transition: 0.2s; }
        input:focus, select:focus { border-color: var(--primary); outline: none; }

        /* LISTA EXPANDIDA */
        .symptoms-list { max-height: 450px; overflow-y: auto; background: #fff; border: 1px solid var(--border); border-radius: 8px; margin-top: 10px; }
        
        /* Cabe√ßalho de Categoria (Ex: Antibi√≥ticos) */
        .cat-header { background: #f1f2f6; color: #7f8c8d; font-size: 0.75rem; font-weight: 800; text-transform: uppercase; padding: 8px 15px; border-bottom: 1px solid #eee; letter-spacing: 1px; margin-top: 0; position: sticky; top: 0; }

        .symptom-item { display: flex; align-items: flex-start; padding: 12px 15px; border-bottom: 1px solid #f0f0f0; cursor: pointer; border-left: 4px solid transparent; }
        .symptom-item:last-child { border-bottom: none; }
        .symptom-item.selected { background-color: #e8f8f5; border-left-color: var(--primary); }
        
        .symptom-item input { width: 22px; height: 22px; margin: 2px 15px 0 0; accent-color: var(--primary); cursor: pointer; flex-shrink: 0; }
        
        .pat-block { display: flex; flex-direction: column; }
        .pat-diagnosis { font-size: 0.95rem; font-weight: 700; color: #c0392b; display: block; margin-bottom: 4px; }
        .pat-treatment { font-size: 0.85rem; color: #27ae60; font-weight: 700; display: flex; align-items: center; gap: 5px; }
        .pat-details { font-size: 0.75rem; color: #7f8c8d; font-weight: normal; margin-left: 5px;}

        /* BOTOES E PREVIEW */
        .btn { width: 100%; padding: 16px; margin-top: 20px; border: none; border-radius: 8px; font-size: 1rem; font-weight: 700; cursor: pointer; box-shadow: 0 4px 6px rgba(0,0,0,0.1); text-transform: uppercase; display: flex; justify-content: center; gap: 8px; transition: 0.2s; }
        .btn:active { transform: scale(0.98); }
        .btn-primary { background: var(--primary); color: white; }
        .btn-share { background: #3498db; color: white; margin-top: 10px; }
        
        .preview-card { background: white; border-radius: 10px; padding: 20px; margin-top: 25px; border: 1px solid var(--border); box-shadow: 0 5px 15px rgba(0,0,0,0.05); display: none; }
        .preview-item { border-bottom: 1px dashed #eee; padding: 10px 0; font-size: 0.9rem; color: #444; }

        /* ALERTAS E CARIMBO */
        .weight-alert { display: none; margin-top: 10px; background: #fff3cd; color: #856404; padding: 10px; border-radius: 6px; font-size: 0.85rem; border: 1px solid #ffeeba; }
        .weight-alert.visible { display: block; }
        
        .stamp-area { border: 2px dashed #bdc3c7; padding: 20px; text-align: center; border-radius: 8px; margin-top: 10px; background: #fafafa; }
        .stamp-preview { max-width: 100%; height: 80px; display: none; margin: 10px auto; border: 1px solid #ddd; padding: 5px; background: white; }

        /* CANVAS */
        .signature-wrapper { border: 2px dashed #95a5a6; border-radius: 8px; background: #fff; margin-top: 10px; position: relative; height: 120px; }
        canvas { width: 100%; height: 100%; cursor: crosshair; }
        .sig-label { position: absolute; top: 5px; left: 10px; color: #ccc; font-size: 0.7rem; pointer-events: none; }

        /* PRINT MODE */
        #print-area { display: none; }
        @page { size: A4; margin: 1.5cm; }
        @media print {
            body { background: white; margin: 0; padding: 0; }
            .container { display: none; }
            #print-area { display: block; width: 100%; font-family: 'Times New Roman', serif; color: #000; }
            .p-header { border-bottom: 2px solid #000; padding-bottom: 10px; margin-bottom: 20px; display: flex; justify-content: space-between; align-items: flex-end; }
            .p-vet-name { font-size: 22px; font-weight: bold; text-transform: uppercase; }
            .p-box { border: 1px solid #999; background: #fdfdfd; padding: 10px; margin-bottom: 20px; font-size: 14px; border-radius: 4px; }
            .p-title { text-align: center; font-size: 18px; font-weight: bold; text-decoration: underline; margin-bottom: 20px; text-transform: uppercase; }
            .p-item { margin-bottom: 15px; page-break-inside: avoid; }
            .p-med-name { font-weight: bold; font-size: 15px; text-transform: uppercase; }
            .p-med-active { font-size: 12px; font-style: italic; font-weight: normal; text-transform: none; }
            .p-med-details { margin-left: 20px; font-size: 14px; margin-top: 4px; line-height: 1.4; }
            .p-footer { margin-top: 40px; text-align: center; page-break-inside: avoid; }
            .p-stamp-img { width: 200px; display: block; margin: 0 auto; }
            .p-timestamp { font-size: 9px; color: #666; text-align: right; margin-top: 30px; border-top: 1px solid #eee; padding-top: 5px; }
        }
    </style>
</head>
<body>

<div class="container">
    <div class="app-header"><h2>üè• VetManager <small style="font-size:0.7em; opacity:0.8">v14.0</small></h2></div>

    <div class="nav-tabs">
        <div class="nav-item active" onclick="switchTab('cadastro')">üìù Prescri√ß√£o</div>
        <div class="nav-item" onclick="switchTab('config')">‚öôÔ∏è M√©dico</div>
    </div>

    <div id="tab-cadastro" class="tab-content active">
        
        <div class="section-title">1. Dados do Paciente</div>
        <input type="text" id="tutor" placeholder="Nome do Tutor">
        
        <div style="display:flex; gap:10px">
            <input type="text" id="animal" placeholder="Animal" style="flex:2">
            <select id="sexo" style="flex:1">
                <option value="Macho">Macho</option>
                <option value="F√™mea">F√™mea</option>
            </select>
        </div>
        
        <div style="display:flex; gap:10px">
            <select id="especie" style="flex:1" onchange="checkWeight()">
                <option value="canino">üê∂ C√£o</option>
                <option value="felino">üê± Gato</option>
            </select>
            <input type="number" id="peso" placeholder="Peso (kg)" step="0.1" style="flex:1" oninput="checkWeight()">
        </div>

        <div id="weightAlert" class="weight-alert">
            ‚ö†Ô∏è <strong>Peso > 20kg:</strong> Sugerimos prefer√™ncia por medica√ß√£o via Oral.
        </div>

        <div class="section-title">2. Diagn√≥stico & Protocolo</div>
        <div class="symptoms-list" id="listaSintomas">
            </div>

        <div class="section-title">3. Adicional / Manual</div>
        <div class="manual-entry-box" style="background:#fff; border:1px solid #ccc; padding:10px; border-radius:8px;">
            <input type="text" id="manualPat" placeholder="Diagn√≥stico (Ex: Otite)">
            <textarea id="manualMed" rows="2" placeholder="Tratamento (Ex: Natalene 3 gotas...)"></textarea>
        </div>

        <div id="canvasArea" style="display:none;">
            <div class="section-title">4. Assinatura</div>
            <div class="signature-wrapper"><span class="sig-label">Assine aqui...</span><canvas id="sigCanvas"></canvas></div>
            <button class="btn" style="background:#e74c3c; padding:8px; font-size:0.8rem; margin-top:5px; width:auto; float:right;" onclick="limparCanvas()">Limpar</button>
            <div style="clear:both"></div>
        </div>
        
        <div id="stampStatus" style="display:none; margin-top:20px; background:#e8f8f5; color:#27ae60; padding:15px; border-radius:8px; text-align:center; border: 1px solid #c3e6cb;">
            ‚úÖ <strong>Carimbo Digital Ativo</strong>
        </div>

        <button class="btn btn-primary" onclick="calcular()">üöÄ Calcular Prescri√ß√£o</button>
        
        <div id="previewArea" class="preview-card">
            <h3 style="margin-top:0; text-align:center; color:#2c3e50; border-bottom:1px solid #eee; padding-bottom:10px;">Resumo</h3>
            <div id="previewList" class="preview-list"></div>
            
            <button class="btn btn-share" onclick="imprimir()">
                üìÑ Gerar PDF & Compartilhar
            </button>
            <div style="text-align:center; margin-top:10px; font-size:0.8rem; color:#777;">
                Nome do arquivo gerado automaticamente com Data e Nome.
            </div>
        </div>
    </div>

    <div id="tab-config" class="tab-content">
        <div class="section-title">üë®‚Äç‚öïÔ∏è Dados do Profissional</div>
        <input type="text" id="vetNome" placeholder="Nome Completo">
        <input type="text" id="vetCRMV" placeholder="CRMV / UF">
        <input type="text" id="vetContato" placeholder="Telefone">

        <div class="section-title">üñºÔ∏è Carimbo Digital</div>
        <div class="stamp-area">
            <p style="font-size:0.8rem; margin-bottom:10px">Imagem PNG Transparente (600x300px)</p>
            <input type="file" id="stampInput" accept="image/*" onchange="salvarCarimbo()">
            <img id="stampPreview" class="stamp-preview">
            <br>
            <button class="btn" style="background:#95a5a6; padding:10px; margin-top:10px; font-size:0.8rem;" onclick="removerCarimbo()">Remover</button>
        </div>
        <button class="btn btn-primary" onclick="salvarTexto()">üíæ Salvar Configura√ß√µes</button>
    </div>
</div>

<div id="print-area">
    <div class="p-header">
        <div>
            <div class="p-vet-name" id="pNome">Dr. Veterin√°rio</div>
            <div class="p-vet-crmv" id="pCRMV">CRMV: ---</div>
        </div>
        <div style="text-align:right; font-size:12px;">
            <span id="pContato"></span><br>Data: <span id="pData"></span>
        </div>
    </div>

    <div class="p-box">
        <strong>Tutor:</strong> <span id="pTutor"></span> | 
        <strong>Paciente:</strong> <span id="pAnimal"></span> (<span id="pEspecie"></span> / <span id="pSexo"></span>)<br>
        <strong>Peso:</strong> <span id="pPeso"></span> kg
    </div>

    <div class="p-title">RECEITU√ÅRIO VETERIN√ÅRIO</div>
    <div id="pLista"></div>

    <div class="p-footer">
        <img id="pStampImg" class="p-stamp-img">
        <div style="border-top:1px solid #000; width:200px; margin:40px auto 5px auto; display:none;" id="pLine"></div>
        <div style="font-weight:bold" id="pNomeRodape">Dr. Veterin√°rio</div>
        <div class="p-timestamp" id="pTimestamp">Gerado em: --/--/----</div>
    </div>
</div>

<script>
    /* BANCO DE DADOS EXPANDIDO (22 ITENS)
       cat: Categoria para agrupamento
       p: Patologia (Diagn√≥stico)
       brand: Marca Veterin√°ria
       salt: Princ√≠pio Ativo
    */
    const database = [
        // --- ANTIBI√ìTICOS ---
        { cat: "Antibi√≥ticos (Infec√ß√µes)", id: 1, p: "Infec√ß√£o Pele (Piodermite Profunda)", brand: "Rilexine / Keflex", salt: "Cefalexina", d: 30, c: 50, u: "ml", a: "Susp. 250mg/5ml", f: "12/12h", t: "14 a 21 dias" },
        { cat: "Antibi√≥ticos (Infec√ß√µes)", id: 2, p: "Infec√ß√£o Urin√°ria / Cistite", brand: "Synulox / Agemoxi", salt: "Amox. + Clavulanato", d: 12.5, c: 50, u: "ml", a: "Susp. 250mg/5ml", f: "12/12h", t: "10 a 14 dias" },
        { cat: "Antibi√≥ticos (Infec√ß√µes)", id: 3, p: "Infec√ß√£o Respirat√≥ria (Pneumonia)", brand: "Doxitec", salt: "Doxiciclina", d: 10, c: 80, u: "comp", a: "Comp 80mg", f: "24/24h", t: "14 a 21 dias" },
        { cat: "Antibi√≥ticos (Infec√ß√µes)", id: 4, p: "Infec√ß√£o Intestinal (Giard√≠ase)", brand: "Giardicid", salt: "Metronidazol + Sulf.", d: 15, c: 50, u: "ml", a: "Susp. 50mg/ml", f: "12/12h", t: "5 a 7 dias" },
        { cat: "Antibi√≥ticos (Infec√ß√µes)", id: 5, p: "Doen√ßa do Carrapato (Erliquiose)", brand: "Doxitec", salt: "Doxiciclina", d: 10, c: 80, u: "comp", a: "Comp 80mg", f: "24/24h", t: "28 dias" },
        { cat: "Antibi√≥ticos (Infec√ß√µes)", id: 6, p: "Infec√ß√£o Bucal (Estomatite)", brand: "Stomorgyl", salt: "Espiramicina + Metro.", d: 20, c: 1, u: "comp", a: "Comp p/ 10kg", f: "24/24h", t: "10 dias" }, /* Dose ajustada para comp comercial (1 comp para 10kg = 1) */

        // --- DOR E INFLAMA√á√ÉO ---
        { cat: "Dor e Inflama√ß√£o", id: 7, p: "Dor Muscular / Articular (AINE)", brand: "Maxicam / Meloxivet", salt: "Meloxicam", dog: 0.1, cat: 0.05, c: 0.5, u: "ml", a: "Sol. 0,5mg/ml", f: "24/24h", t: "3 a 4 dias" },
        { cat: "Dor e Inflama√ß√£o", id: 8, p: "P√≥s-Operat√≥rio / Dor Forte", brand: "Cronidor / Tramadol", salt: "Clorid. Tramadol", d: 3, c: 50, u: "comp", a: "Comp. 50mg", f: "8/8h", t: "3 a 5 dias" },
        { cat: "Dor e Inflama√ß√£o", id: 9, p: "Febre / Dor Simples", brand: "Novalgina / Dipirona", salt: "Dipirona S√≥dica", d: 25, c: 500, u: "ml", a: "Gotas 500mg/ml", f: "6/6h", t: "Se houver dor" },
        { cat: "Dor e Inflama√ß√£o", id: 10, p: "Alergia Aguda / Prurido", brand: "Prediderm / Predsim", salt: "Prednisolona", d: 0.5, c: 5, u: "comp", a: "Comp. 5mg", f: "24/24h", t: "5 a 7 dias" },
        { cat: "Dor e Inflama√ß√£o", id: 11, p: "Dor Cr√¥nica / Coluna", brand: "Gabapentina", salt: "Gabapentina", d: 10, c: 100, u: "comp", a: "C√°ps 100mg", f: "12/12h", t: "Uso cont√≠nuo" },

        // --- GASTROINTESTINAL ---
        { cat: "Gastrointestinal", id: 12, p: "V√¥mito / √ämese", brand: "Vonau Vet", salt: "Ondansetrona", d: 0.5, c: 2, u: "ml", a: "2mg/ml", f: "8/8h", t: "Se v√¥mito" },
        { cat: "Gastrointestinal", id: 13, p: "V√¥mito / Motilidade G√°strica", brand: "Plasil / Drasil", salt: "Metoclopramida", d: 0.5, c: 4, u: "ml", a: "Gotas 4mg/ml", f: "8/8h", t: "Se v√¥mito" },
        { cat: "Gastrointestinal", id: 14, p: "Prote√ß√£o G√°strica", brand: "Gaviz / Omeprazol", salt: "Omeprazol", d: 1, c: 10, u: "comp", a: "Comp. 10mg", f: "24/24h", t: "Jejum" },
        { cat: "Gastrointestinal", id: 15, p: "Diarreia Inespec√≠fica", brand: "Probi√≥tico", salt: "Lactobacillus", d: 1, c: 1, u: "ml", a: "Pasta Oral", f: "24/24h", t: "3 a 5 dias" }, /* L√≥gica simplificada: 1 dose */

        // --- DIVERSOS ---
        { cat: "Outros", id: 16, p: "Verminose Intestinal", brand: "Drontal / Top Dog", salt: "Praziquantel+", d: 1, c: 10, u: "comp", a: "Comp p/ 10kg", f: "Dose √önica", t: "Repetir 15 dias" },
        { cat: "Outros", id: 17, p: "Sarna Sarc√≥ptica / Otod√©scica", brand: "Simparic / Bravecto", salt: "Isoxazolina", d: 1, c: 1, u: "comp", a: "Conforme Peso", f: "Dose √önica", t: "Mensal/Trimestral" }, /* L√≥gica simplificada */
        { cat: "Outros", id: 18, p: "Tosse (Traqueobronquite)", brand: "Fluimucil", salt: "Acetilciste√≠na", d: 10, c: 20, u: "ml", a: "Xarope 20mg/ml", f: "12/12h", t: "5 a 7 dias" },
        { cat: "Outros", id: 19, p: "Infec√ß√£o F√∫ngica (Pele)", brand: "Cetoconazol", salt: "Cetoconazol", d: 10, c: 200, u: "comp", a: "Comp 200mg", f: "12/12h", t: "21 dias" },
        { cat: "Outros", id: 20, p: "Insufici√™ncia Card√≠aca (Diur√©tico)", brand: "Lasix", salt: "Furosemida", d: 2, c: 40, u: "comp", a: "Comp 40mg", f: "12/12h", t: "Uso cont√≠nuo" },
        { cat: "Outros", id: 21, p: "Seda√ß√£o (Transporte)", brand: "Acepran", salt: "Acepromazina", d: 0.5, c: 10, u: "ml", a: "Gotas 10mg/ml", f: "Se necess√°rio", t: "40min antes" },
        { cat: "Outros", id: 22, p: "Limpeza de Ouvido", brand: "Clean Up / Epiotic", salt: "Ceruminol√≠tico", d: 1, c: 1, u: "ml", a: "Solu√ß√£o", f: "24/24h", t: "Antes do rem√©dio" }
    ];

    /* INICIALIZA√á√ÉO */
    const canvas = document.getElementById('sigCanvas');
    const ctx = canvas.getContext('2d');
    let cacheRx = [];
    let originalTitle = document.title;

    window.onload = () => {
        carregarConfig();
        gerarLista();
        checarCarimbo();
        setupCanvas();
    };

    /* VISUAL & FORM */
    function checkWeight() {
        const peso = parseFloat(document.getElementById('peso').value);
        const especie = document.getElementById('especie').value;
        const alertBox = document.getElementById('weightAlert');
        if(especie === 'canino' && peso > 20) alertBox.classList.add('visible');
        else alertBox.classList.remove('visible');
    }

    function toggleSelect(element) {
        if(element.checked) element.closest('.symptom-item').classList.add('selected');
        else element.closest('.symptom-item').classList.remove('selected');
    }

    function gerarLista() {
        const div = document.getElementById('listaSintomas');
        div.innerHTML = "";
        const grouped = database.reduce((acc, curr) => { (acc[curr.cat] = acc[curr.cat] || []).push(curr); return acc; }, {});
        
        for (const [cat, items] of Object.entries(grouped)) {
            // Header da Categoria
            div.innerHTML += `<div class="cat-header">${cat}</div>`;
            
            items.forEach(item => {
                div.innerHTML += `
                    <label class="symptom-item">
                        <input type="checkbox" value="${item.id}" onchange="toggleSelect(this)">
                        <div class="pat-block">
                            <span class="pat-diagnosis">${item.p}</span>
                            <span class="pat-treatment">üíä ${item.brand}</span>
                            <span class="pat-details">(${item.salt} - ${item.a})</span>
                        </div>
                    </label>
                `;
            });
        }
    }

    /* CALCULO */
    function formatDose(val, type, nome) {
        if(type !== 'ml') {
            const dec = val - Math.floor(val);
            if(dec < 0.1 || dec > 0.9) return Math.round(val) + " comp";
            if(val <= 0.25) return "1/4 comp";
            if(val <= 0.6) return "1/2 comp";
            if(val <= 0.85) return "3/4 comp";
            return Math.ceil(val) + " comp";
        }
        let vol = val < 0.1 ? 0.1 : (val < 3 ? Math.round(val*10)/10 : (val <= 10 ? Math.round(val*5)/5 : (Math.round(val*2)/2).toFixed(1)));
        if(typeof vol === 'number') vol = vol % 1 === 0 ? vol.toFixed(0) : vol.toFixed(1);
        let txt = vol + " ml";
        if(val < 3 && (nome.includes("Dipirona") || nome.includes("Ondansetrona") || nome.includes("Acepran") || nome.includes("Plasil"))) txt += ` (~${Math.round(val*20)} gts)`;
        return txt;
    }

    function calcular() {
        const peso = parseFloat(document.getElementById('peso').value);
        const esp = document.getElementById('especie').value;
        const checks = document.querySelectorAll('#listaSintomas input:checked');
        const manPat = document.getElementById('manualPat').value;
        const manMed = document.getElementById('manualMed').value;

        if((!peso || checks.length === 0) && (!manPat || !manMed)) { 
            alert("Preencha o Peso e selecione uma Patologia."); return; 
        }

        cacheRx = [];
        const prev = document.getElementById('previewList');
        prev.innerHTML = "";

        checks.forEach(chk => {
            const m = database.find(p => p.id == chk.value);
            
            // L√≥gica Especial para itens "Dose √önica" ou "Por Peso/Faixa"
            let doseFinal = "";
            if(m.brand.includes("Simparic") || m.brand.includes("Drontal")) {
                doseFinal = "1 dose (conforme peso)";
            } else if(m.brand.includes("Probi√≥tico")) {
                doseFinal = "2 a 4g (1 medida)";
            } else {
                let doseBase = m.d;
                if(m.brand.includes('Maxicam')) doseBase = (esp === 'canino') ? m.dog : m.cat;
                
                // C√°lculo Padr√£o
                const qtd = (peso * doseBase) / m.c;
                doseFinal = formatDose(qtd, m.u, m.brand);
            }
            
            let via = (esp === 'canino' && peso > 20) ? "VIA ORAL (Preferencial)" : "via oral";

            cacheRx.push({ brand: m.brand, salt: m.salt, a: m.a, dose: doseFinal, freq: m.f, dur: m.t, via: via });
            prev.innerHTML += `<div class="preview-item"><strong>${m.brand}</strong>: ${doseFinal}<br><small>${m.f}</small></div>`;
        });

        if(manPat && manMed) {
            cacheRx.push({ brand: "Protocolo Manual", salt: manPat, a: "Personalizado", dose: manMed, freq: "Conforme descrito", dur: "-", via: "-" });
            prev.innerHTML += `<div class="preview-item"><strong>${manPat}</strong><br><small>Personalizado</small></div>`;
        }

        // --- ATUALIZA√á√ÉO DO NOME DO ARQUIVO AQUI (CRUCIAL PARA O CELULAR PEGAR) ---
        const now = new Date();
        const pad = (n) => n.toString().padStart(2, '0');
        const nomeAnimal = (document.getElementById('animal').value || 'SemNome').replace(/[^a-z0-9]/gi, '');
        const tipo = document.getElementById('especie').value === 'canino' ? 'Cao' : 'Gato';
        const sexo = document.getElementById('sexo').value;
        
        // Define o t√≠tulo da p√°gina agora. O navegador usar√° isso ao gerar o PDF.
        document.title = `${now.getFullYear()}-${pad(now.getMonth()+1)}-${pad(now.getDate())}_${pad(now.getHours())}-${pad(now.getMinutes())}_Receita_(${tipo}-${sexo}-${nomeAnimal})`;

        document.getElementById('previewArea').style.display = 'block';
        document.getElementById('previewArea').scrollIntoView({behavior:'smooth'});
    }

    /* IMPRESS√ÉO */
    function imprimir() {
        const now = new Date();
        document.getElementById('pNome').innerText = localStorage.getItem('vetNome');
        document.getElementById('pCRMV').innerText = localStorage.getItem('vetCRMV');
        document.getElementById('pContato').innerText = localStorage.getItem('vetContato');
        document.getElementById('pData').innerText = now.toLocaleDateString('pt-BR');
        
        document.getElementById('pTutor').innerText = document.getElementById('tutor').value;
        document.getElementById('pAnimal').innerText = document.getElementById('animal').value;
        document.getElementById('pEspecie').innerText = document.getElementById('especie').value;
        document.getElementById('pSexo').innerText = document.getElementById('sexo').value;
        document.getElementById('pPeso').innerText = document.getElementById('peso').value;
        document.getElementById('pNomeRodape').innerText = localStorage.getItem('vetNome');
        document.getElementById('pTimestamp').innerText = `Gerado eletronicamente em: ${now.toLocaleString('pt-BR')}`;

        const pl = document.getElementById('pLista');
        pl.innerHTML = "";
        cacheRx.forEach((m, i) => {
            if(m.a === "Personalizado") {
                pl.innerHTML += `<div class="p-item"><div class="p-med-name"><span>${i+1}. ${m.salt}</span> <small>(Manual)</small></div><div class="p-med-details" style="white-space: pre-wrap;">${m.dose}</div></div>`;
            } else {
                pl.innerHTML += `
                <div class="p-item">
                    <div class="p-med-name">
                        <span>${i+1}. ${m.brand} <small>(${m.a})</small></span>
                    </div>
                    <div class="p-med-active">Princ√≠pio: ${m.salt}</div>
                    <div class="p-med-details">
                        <strong>Administrar:</strong> ${m.dose} ${m.via}.<br>
                        <strong>Posologia:</strong> ${m.f} durante ${m.dur}.
                    </div>
                </div>`;
            }
        });

        const stamp = localStorage.getItem('vetStampImg');
        const img = document.getElementById('pStampImg');
        const line = document.getElementById('pLine');
        if(stamp) { img.src = stamp; img.style.display='block'; line.style.display='none'; }
        else { img.src = canvas.toDataURL(); img.style.display='block'; line.style.display='none'; }

        window.print();
        
        // Timeout para voltar o t√≠tulo original (Opcional, mas boa pr√°tica)
        setTimeout(() => { document.title = "VetManager v14.0"; }, 2000);
    }

    /* CONFIG & CANVAS */
    function switchTab(t){ document.querySelectorAll('.tab-content').forEach(c=>c.classList.remove('active')); document.querySelectorAll('.nav-item').forEach(n=>n.classList.remove('active')); document.getElementById('tab-'+t).classList.add('active'); document.querySelectorAll('.nav-item')[t==='cadastro'?0:1].classList.add('active'); if(t==='cadastro'){checarCarimbo();setTimeout(resizeCanvas,200);} }
    function salvarTexto(){ localStorage.setItem('vetNome',document.getElementById('vetNome').value); localStorage.setItem('vetCRMV',document.getElementById('vetCRMV').value); localStorage.setItem('vetContato',document.getElementById('vetContato').value); alert("Salvo!"); }
    function salvarCarimbo(){ const f=document.getElementById('stampInput').files[0]; if(!f)return; const r=new FileReader(); r.onloadend=()=>{localStorage.setItem('vetStampImg',r.result); checarCarimbo(); alert("Carimbo Salvo!");}; r.readAsDataURL(f); }
    function removerCarimbo(){ localStorage.removeItem('vetStampImg'); checarCarimbo(); }
    function carregarConfig(){ document.getElementById('vetNome').value=localStorage.getItem('vetNome')||""; document.getElementById('vetCRMV').value=localStorage.getItem('vetCRMV')||""; document.getElementById('vetContato').value=localStorage.getItem('vetContato')||""; }
    function checarCarimbo(){ if(localStorage.getItem('vetStampImg')){ document.getElementById('canvasArea').style.display='none'; document.getElementById('stampStatus').style.display='block'; }else{ document.getElementById('canvasArea').style.display='block'; document.getElementById('stampStatus').style.display='none'; } }
    let drawing=false;
    function setupCanvas(){ ['mousedown','touchstart'].forEach(e=>canvas.addEventListener(e,ds)); ['mouseup','touchend'].forEach(e=>canvas.addEventListener(e,de)); ['mousemove','touchmove'].forEach(e=>canvas.addEventListener(e,dd)); }
    function resizeCanvas(){ const p=canvas.parentElement; canvas.width=p.clientWidth; canvas.height=p.clientHeight; ctx.lineWidth=2; ctx.strokeStyle="#000080"; }
    function ds(e){ drawing=true; ctx.beginPath(); dd(e); }
    function de(){ drawing=false; ctx.beginPath(); }
    function dd(e){ if(!drawing)return; e.preventDefault(); const r=canvas.getBoundingClientRect(); const x=(e.touches?e.touches[0].clientX:e.clientX)-r.left; const y=(e.touches?e.touches[0].clientY:e.clientY)-r.top; ctx.lineTo(x,y); ctx.stroke(); }
    function limparCanvas(){ ctx.clearRect(0,0,canvas.width,canvas.height); }
</script>
</body>
</html>
